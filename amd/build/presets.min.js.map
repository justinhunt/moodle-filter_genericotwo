{"version":3,"file":"presets.min.js","sources":["../src/presets.js"],"sourcesContent":["define(['jquery', 'core/log'], function ($, log) {\n\n    \"use strict\";\n\n    log.debug('Filter GenericoTwo Presets initialising');\n\n    return {\n\n        presetdata: false,\n\n        // IDs of fields in the form. 'id_' + fieldname\n        dataitems: [\n            'version',\n            'templatekey',\n            'name',\n            'instructions',\n            'content',\n            'templateend',\n            'variabledefaults',\n            'jscontent',\n            'previewcontext',\n            'importcss',\n            'customcss',\n            'dataset',\n            'datasetvars',\n            'allowedcontexts',\n            'allowedcontextids'\n        ],\n\n        // Mapping from preset keys (Generico style or common sense) to our form fields\n        // Simplifies things if we use same keys in JSON export as form fields.\n\n        fetchcontrols: function () {\n            var controls = {};\n            // Loop through dataitems and get element by id\n            this.dataitems.forEach(function (item) {\n                controls[item] = document.getElementById('id_' + item);\n            });\n            return controls;\n        },\n\n        fetchjsonbundle: function (controls) {\n            var bundle = {};\n            this.dataitems.forEach(function (item) {\n                if (controls[item]) {\n                    bundle[item] = controls[item].value;\n                }\n            });\n            var jsonbundle = JSON.stringify(bundle);\n            return jsonbundle;\n        },\n\n        exportbundle: function () {\n            var controls = this.fetchcontrols();\n            if (!controls.templatekey || controls.templatekey.value == '') {\n                // If no key, maybe use name, or default\n                var filename = 'preset';\n                if (controls.name && controls.name.value) {\n                    filename = controls.name.value;\n                }\n            } else {\n                filename = controls.templatekey.value;\n            }\n\n            var jsonbundle = this.fetchjsonbundle(controls);\n\n            var pom = document.createElement('a');\n            pom.setAttribute('href', \"data:text/json;charset=utf-8,\" + encodeURIComponent(jsonbundle));\n            pom.setAttribute('download', filename + '.txt');\n\n            if (document.createEvent) {\n                var event = document.createEvent('MouseEvents');\n                event.initEvent('click', true, true);\n                pom.dispatchEvent(event);\n            }\n            else {\n                pom.click();\n            }\n        },\n\n\n\n        populateform: function (presetindex, presetdata) {\n            var controls = this.fetchcontrols();\n\n            // Check if we have data (index 0 is valid so check specifically for null/empty string)\n            if ((presetindex === '' || presetindex === null) && !presetdata) {\n                return;\n            }\n\n            var selectedPreset = null;\n\n            if (typeof presetdata !== 'undefined' && presetdata) {\n                // Passed directly (drag and drop)\n                selectedPreset = presetdata[0]; // Generico passes array of 1\n            } else {\n                // From dropdown\n                if (!this.presetdata) {\n                    return;\n                }\n                selectedPreset = this.presetdata[presetindex];\n            }\n\n            if (!selectedPreset) {\n                return;\n            }\n\n            var that = this;\n            // Iterate and set values\n            this.dataitems.forEach(function (item) {\n                // Handling mapping from Generico preset names to our names if needed?\n                // Generico keys: key, name, instructions, body, bodyend, requirecss, requirejs, etc.\n                // Our keys: templatekey, name, instructions, content, templateend, importcss, jscontent, etc.\n\n                // Let's check for standard Generico keys and map them if the specific item is missing in preset\n                var value = null;\n\n                // Direct match\n                if (selectedPreset.hasOwnProperty(item)) {\n                    value = selectedPreset[item];\n                }\n                // Mappings for compatibility with Generico Export files\n                else {\n                    switch (item) {\n                        case 'templatekey':\n                            if (selectedPreset.hasOwnProperty('key')) value = selectedPreset.key;\n                            break;\n                        case 'content':\n                            if (selectedPreset.hasOwnProperty('body')) value = selectedPreset.body;\n                            break;\n                        case 'templateend':\n                            if (selectedPreset.hasOwnProperty('bodyend')) value = selectedPreset.bodyend;\n                            break;\n                        case 'importcss':\n                            if (selectedPreset.hasOwnProperty('requirecss')) value = selectedPreset.requirecss;\n                            break;\n                        case 'customcss':\n                            if (selectedPreset.hasOwnProperty('style')) value = selectedPreset.style;\n                            break;\n                        case 'jscontent':\n                            // Generico has 'script' (custom JS) and 'requirejs' (url)\n                            // GenericoTwo has 'jscontent'. \n                            if (selectedPreset.hasOwnProperty('script')) value = selectedPreset.script;\n                            break;\n                        case 'variabledefaults':\n                            if (selectedPreset.hasOwnProperty('defaults')) value = selectedPreset.defaults;\n                            break;\n                    }\n                }\n\n                if (controls[item] && value !== null) {\n                    // Check Ace editor\n                    if (window.ace) {\n                        // Find editor\n                        // The textarea might be hidden by Ace\n                        // But Ace syncs on change.\n                        // We need to set value on Ace if it exists for this field.\n                        // But we don't have direct ref here easily unless we look for it.\n                        // Simplest is to update textarea, then if Ace exists, update it?\n                        // Or update textarea and trigger change?\n                        $(controls[item]).val(value).trigger('change');\n\n                        // Manually check if there is an ace editor associated\n                        // Our ace_init creates div with class same as textarea\n                        // Easier: check id\n                        // But we don't know the editor instance.\n                        // Let's trigger a custom event or check if ace_init handles external updates? \n                        // ace_init listens on editor change to update textarea.\n                        // It does NOT listen on textarea change to update editor.\n                        // So we might need to find the editor. \n                        var editorEnv = ace.edit($(controls[item]).prev()[0]); // previous sibling is the editDiv\n                        if (editorEnv && editorEnv.setValue) {\n                            editorEnv.setValue(value, 1);\n                        }\n                    } else {\n                        $(controls[item]).val(value);\n                    }\n                }\n            });\n\n        },\n\n        dopopulate: function (templatedata) {\n            this.populateform(0, new Array(templatedata));\n        },\n\n        init: function (opts) {\n            if (!this.presetdata) {\n                var controlid = '#id_filter_genericotwo_presetdata';\n                var presetcontrol = $(controlid).get(0);\n                if (presetcontrol) {\n                    this.presetdata = JSON.parse(presetcontrol.value);\n                    // $(controlid).remove(); // Keep it for debug? Or remove like Generico?\n                }\n            }\n\n            var thismodule = this;\n            // Handle the select box change event\n            $('#id_filter_genericotwo_presets').change(function () {\n                thismodule.populateform($(this).val());\n            });\n\n            // Drag drop square events\n            var ddsquareid = '#id_filter_genericotwo_dragdropsquare';\n\n            // Export the current bundle\n            $(ddsquareid).on(\"click\", function () {\n                thismodule.exportbundle();\n            });\n\n\n            // Handle the drop event.\n            $(ddsquareid).on(\"dragover\", function (event) {\n                event.preventDefault();\n                event.stopPropagation();\n                $(this).addClass('filter_genericotwo_dragging');\n            });\n\n            $(ddsquareid).on(\"dragleave\", function (event) {\n                event.preventDefault();\n                event.stopPropagation();\n                $(this).removeClass('filter_genericotwo_dragging');\n            });\n\n            $(ddsquareid).on('drop', function (event) {\n                event.preventDefault();\n                var files = event.originalEvent.dataTransfer.files;\n\n                if (files.length) {\n                    var f = files[0];\n                    if (f) {\n                        var r = new FileReader();\n                        r.onload = function (e) {\n                            var contents = e.target.result;\n                            try {\n                                var templatedata = JSON.parse(contents);\n                                // Check if it looks valid?\n                                if (templatedata.key || templatedata.templatekey) {\n                                    thismodule.dopopulate(templatedata);\n                                }\n                            } catch (e) {\n                                alert(\"Invalid JSON file\");\n                            }\n                        };\n                        r.readAsText(f);\n                    }\n                }\n                $(this).removeClass('filter_genericotwo_dragging');\n            });\n        }\n    };\n});\n"],"names":["define","$","log","debug","presetdata","dataitems","fetchcontrols","controls","forEach","item","document","getElementById","fetchjsonbundle","bundle","value","JSON","stringify","exportbundle","this","templatekey","filename","name","jsonbundle","pom","createElement","setAttribute","encodeURIComponent","createEvent","event","initEvent","dispatchEvent","click","populateform","presetindex","selectedPreset","hasOwnProperty","key","body","bodyend","requirecss","style","script","defaults","window","ace","val","trigger","editorEnv","edit","prev","setValue","dopopulate","templatedata","Array","init","opts","presetcontrol","get","parse","thismodule","change","ddsquareid","on","preventDefault","stopPropagation","addClass","removeClass","files","originalEvent","dataTransfer","length","f","r","FileReader","onload","e","contents","target","result","alert","readAsText"],"mappings":"AAAAA,oCAAO,CAAC,SAAU,aAAa,SAAUC,EAAGC,YAIxCA,IAAIC,MAAM,2CAEH,CAEHC,YAAY,EAGZC,UAAW,CACP,UACA,cACA,OACA,eACA,UACA,cACA,mBACA,YACA,iBACA,YACA,YACA,UACA,cACA,kBACA,qBAMJC,cAAe,eACPC,SAAW,eAEVF,UAAUG,SAAQ,SAAUC,MAC7BF,SAASE,MAAQC,SAASC,eAAe,MAAQF,SAE9CF,UAGXK,gBAAiB,SAAUL,cACnBM,OAAS,eACRR,UAAUG,SAAQ,SAAUC,MACzBF,SAASE,QACTI,OAAOJ,MAAQF,SAASE,MAAMK,UAGrBC,KAAKC,UAAUH,SAIpCI,aAAc,eACNV,SAAWW,KAAKZ,mBACfC,SAASY,aAA6C,IAA9BZ,SAASY,YAAYL,MAO9CM,SAAWb,SAASY,YAAYL,UAP2B,KAEvDM,SAAW,SACXb,SAASc,MAAQd,SAASc,KAAKP,QAC/BM,SAAWb,SAASc,KAAKP,WAM7BQ,WAAaJ,KAAKN,gBAAgBL,UAElCgB,IAAMb,SAASc,cAAc,QACjCD,IAAIE,aAAa,OAAQ,gCAAkCC,mBAAmBJ,aAC9EC,IAAIE,aAAa,WAAYL,SAAW,QAEpCV,SAASiB,YAAa,KAClBC,MAAQlB,SAASiB,YAAY,eACjCC,MAAMC,UAAU,SAAS,GAAM,GAC/BN,IAAIO,cAAcF,YAGlBL,IAAIQ,SAMZC,aAAc,SAAUC,YAAa7B,gBAC7BG,SAAWW,KAAKZ,mBAGC,KAAhB2B,aAAsC,OAAhBA,aAA0B7B,gBAIjD8B,eAAiB,aAEK,IAAf9B,YAA8BA,WAErC8B,eAAiB9B,WAAW,OACzB,KAEEc,KAAKd,kBAGV8B,eAAiBhB,KAAKd,WAAW6B,gBAGhCC,qBAMA7B,UAAUG,SAAQ,SAAUC,UAMzBK,MAAQ,QAGRoB,eAAeC,eAAe1B,MAC9BK,MAAQoB,eAAezB,kBAIfA,UACC,cACGyB,eAAeC,eAAe,SAAQrB,MAAQoB,eAAeE,eAEhE,UACGF,eAAeC,eAAe,UAASrB,MAAQoB,eAAeG,gBAEjE,cACGH,eAAeC,eAAe,aAAYrB,MAAQoB,eAAeI,mBAEpE,YACGJ,eAAeC,eAAe,gBAAerB,MAAQoB,eAAeK,sBAEvE,YACGL,eAAeC,eAAe,WAAUrB,MAAQoB,eAAeM,iBAElE,YAGGN,eAAeC,eAAe,YAAWrB,MAAQoB,eAAeO,kBAEnE,mBACGP,eAAeC,eAAe,cAAarB,MAAQoB,eAAeQ,aAK9EnC,SAASE,OAAmB,OAAVK,SAEd6B,OAAOC,IAAK,CAQZ3C,EAAEM,SAASE,OAAOoC,IAAI/B,OAAOgC,QAAQ,cAUjCC,UAAYH,IAAII,KAAK/C,EAAEM,SAASE,OAAOwC,OAAO,IAC9CF,WAAaA,UAAUG,UACvBH,UAAUG,SAASpC,MAAO,QAG9Bb,EAAEM,SAASE,OAAOoC,IAAI/B,aAOtCqC,WAAY,SAAUC,mBACbpB,aAAa,EAAG,IAAIqB,MAAMD,gBAGnCE,KAAM,SAAUC,UACPrC,KAAKd,WAAY,KAEdoD,cAAgBvD,EADJ,qCACiBwD,IAAI,GACjCD,qBACKpD,WAAaW,KAAK2C,MAAMF,cAAc1C,YAK/C6C,WAAazC,KAEjBjB,EAAE,kCAAkC2D,QAAO,WACvCD,WAAW3B,aAAa/B,EAAEiB,MAAM2B,cAIhCgB,WAAa,wCAGjB5D,EAAE4D,YAAYC,GAAG,SAAS,WACtBH,WAAW1C,kBAKfhB,EAAE4D,YAAYC,GAAG,YAAY,SAAUlC,OACnCA,MAAMmC,iBACNnC,MAAMoC,kBACN/D,EAAEiB,MAAM+C,SAAS,kCAGrBhE,EAAE4D,YAAYC,GAAG,aAAa,SAAUlC,OACpCA,MAAMmC,iBACNnC,MAAMoC,kBACN/D,EAAEiB,MAAMgD,YAAY,kCAGxBjE,EAAE4D,YAAYC,GAAG,QAAQ,SAAUlC,OAC/BA,MAAMmC,qBACFI,MAAQvC,MAAMwC,cAAcC,aAAaF,SAEzCA,MAAMG,OAAQ,KACVC,EAAIJ,MAAM,MACVI,EAAG,KACCC,EAAI,IAAIC,WACZD,EAAEE,OAAS,SAAUC,OACbC,SAAWD,EAAEE,OAAOC,eAEhB1B,aAAerC,KAAK2C,MAAMkB,WAE1BxB,aAAahB,KAAOgB,aAAajC,cACjCwC,WAAWR,WAAWC,cAE5B,MAAOuB,GACLI,MAAM,uBAGdP,EAAEQ,WAAWT,IAGrBtE,EAAEiB,MAAMgD,YAAY"}